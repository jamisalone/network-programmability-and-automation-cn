# 网络管理平台SNMP到设备API的演进

如果想要改善日常管理和运维网络的方式，改善必须从如何与被管理的底层设备交互\(interface with\)开始。这个接口\(interface\)是你和自动化工具与设备进行通信的方式，以执行各种类型的网络自动化，如数据收集\(data collection\)和配置管理\(configuration management\)。在本节中，将对可用于连接到网络设备管理平面的不同方法进行概述，首先从SNMP开始，然后是更现代化的方式，如NETCONF和RESTful APIs。然后，我们看看_open networking_ movement \(开放网络运动\)对网络运维和自动化的影响。

## APIs

作为网工，你需要拥抱进击的APIs，不能畏惧它们。API只是一种用于一个设备的软件和另一个设备的软件进行沟通的机制。APIs如今被用于互联网的任何角落 — 它们只是碰巧终于得到了网络厂商应用的关注。我们不久将会看到APIs将会成为管理网络设备的主要方式。

### SNMP

* SNMP已经在网络设备上广泛部署了20多年，SNMP是一个很常用的协议，用于轮询网络设备的信息，如上/下行状态和CPU、内存和接口利用率；
* 要部署SNMP，被管理设备上必须有一个SNMP代理\(SNMP agent\)和一个网络管理站点\(Network Management Station, NMS\)，NMS是作为监视和/或控制被管理设备的服务器的设备。
* 每个被管理的网络设备都会公开出一组数据，可以通过SNMP代理\(SNMP agent\)收集和配置这些数据。通过SNMP管理的这组数据是通过管理信息库\(Management Information Bases, MIBs\)来描述和建模的。只有当有一个MIB公开了某个功能时，才能对其进行监控或管理。这包括通过SNMP进行配置更改。经常被忽略的是，SNMP不仅支持GetRequests来监控，还支持SetRequests来操作通过MIB公开的对象和变量。问题是，没有多少厂商提供通过SNMP进行配置管理的全面支持；即使有，也往往使用自定义的MIBs，从而减慢了对网络管理平台的集成过程。
* 如前所述，SNMP已经存在了几十年，但它并不是为了成为网络设备的实时程序化接口而建立的。我们已经看到供应商声称SNMP逐渐死亡，因为它涉及到下一代管理和自动化工具。尽管如此，SNMP确实存在于几乎所有的网络设备上，而且SNMP的Python库也存在--所以，如果你需要从大量的设备类型中收集基本信息，使用SNMP可能还是有意义的。

### SSH/Telnet and the CLI

* 如果你曾管理过网络设备，就一定使用过CLI来发出命令，在设备上执行一些动作；你大概率是通过Telnet或SSH会话来输入命令的。从Telnet向SSH的迁移可以说是我们在过去十年中在网络运维方面最大的转变，这种转变不是关于运维的，而是关于安全的，确保网络设备的通信是加密的。
* CLI是为人类设计的，是为人类运维人员提供设备可用性的，然而CLI不是用来机器对机器通信的；
  * 如果在设备的CLI上执行`show`命令，会返回未处理过的原始文本，它是无结构的；
  * 解析这个无结构文本的最佳选择是使用`pipe`\( `|` \)和关键词，如`grep`，`include`和`begin`来筛查配置文本中的特定行；
* 在过去20年里面，我们只有CLI，此间逐渐出现大量的网络管理平台和自定义脚本，在SSH处理脚本和手动解析的基础上，使用CLI进行管理和自动化操作。这并不是说SSH/CLI使其无法实现自动化，相反，它使**自动化极易出错，而且很繁琐**。
* 网络厂商开始意识到这一点，现在大多数新的设备平台都有某种类型的API，可以简化机器与机器之间的通信（很多还不完善，所以一定确保去测试过你最喜好的设备API），产生了一种更简单的自动化方法，也更符合一般的软件开发原则。

### NETCONF

* NETCONF是一种网络管理层协议。在最高层次上，它可以与SNMP相提并论，因为它们都是用来对网络设备进行配置更改和检索数据的协议。
* A few high-level points
  * NETCONF是一个**面向连接**的协议，通常利用**SSH**作为其传输方式；
  * NETCONF客户端（自动化工具/脚本）和NETCONF服务器（网络设备）之间发送的数据用**XML**编码；
  * 远程过程调用\(Remote Procedure Call, RPC\)被编码在发送到设备的XML文档中，设备会处理这些RPC；`<rpc>`元素用于封装从客户端发送到服务器的NETCONF请求；在这种情况下，将这些远程过程调用\(RPC\)视为在设备上执行预先安排的操作；RPCs是客户端向服务器进行通信的一种方式，这种方式将告诉服务器，客户端请求的结构和类型；
  * 支持的RPCs直接映射到特定设备所支持的NETCONF操作和功能。例如，如果你是在设备上进行更改，你使用`edit-config`操作。如果您要检索配置数据，您可以使用`get`或`get-config`操作。这些操作将要发送给设备的`<rpc>`元素封装在XML文档中。
* 此外，NETCONF的价值在于它**支持基于事务的更改**。这意味着，如果你在一个给定的NETCONF会话或单个XML文档中进行了多个更改，而其中一个更改失败，则完整的更改不会应用到设备上（当然，这些类型的设置通常也可以被覆盖）。这与依次发送CLI命令，最后由于打字错误或无效命令而导致部分配置不同。
* 值得指出的是，仅仅因为两个不同的设备平台支持NETCONF（或任何通用的传输方法支持NETCONF），并不意味着从工具和开发角度来看它们是兼容的。即使假设两个设备都支持相同的NETCONF特性和功能，但数据如何建模，更多的时候是厂商指定的。数据建模就是设备如何表示状态和配置数据，这将更多涉及**JSON**和**XML**以及**YANG**（一种常见的数据建模语言）的数据表示。

### RESTful APIs

* REST\(REpresentational State Transfer\)是一种用于**设计和开发网络应用**的架构**风格**。
  * 因此，实现和坚持基于**REST架构的系统**被称为**RESTful**
  * REST是风格，RESTful是基于REST架构的系统
  * 最常见的公开API和使用REST架构风格的设备是网络控制器 \(network controller\)，也就是说，存在公开RESTful和基于HTTP的API的网络设备。
* 虽然从网络的角度来看，REST和RESTful API这些术语是新的，但当你使用网络浏览器浏览互联网时，你在日常生活中已经与许多RESTful系统进行交互了。REST是一种用于开发网络应用的风格，这种风格依赖于无状态的客户端-服务器模型\(client-server model\)，其中客户端一直跟踪会话\(session\)，而服务器上不持有客户端状态或情况\(client state or context\)。最好的是，使用的底层传输协议是最常见的HTTP。
* 这意味着RESTful API的操作就像基于HTTP的系统一样。
  * 首先，你需要一个通过URL（即SDN控制器或网络设备进行通信）访问的Web服务器
  * 其次，你需要向该URL发送相关的HTTP请求\(HTTP request\)
* Example
  * 如果你需要从SDN控制器中检索设备列表，你只需要向给定的设备URL发送一个HTTP GET，它可能看起来像这样：`http://1.1.1.1/v1/devices`。
  * 返回的响应\(response\)将是某种类型的结构化数据，如XML或JSON
* 身份验证、数据编码，以及在进行配置更改时如何发送HTTP请求（HTTP PUT/POST/PATCH）等未提及的内容将在后面文章中展现

## Impact of Open Networking

* 所有的东西都有一个不断增长的趋势，open source， open networking，Open APIs，OpenFlow，Open Compute，Open vSwitch，OpenDaylight，OpenConfig等等，不胜枚举。虽然关于开放的定义存在争议，但有一点是肯定的：开放网络运动\(open networking movement\)正在改善网络运维和自动化方面的可能性。
* 伴随着这场运动，可以看到网络设备发生了巨大的变化，这也是作者写本书的一个主要原因。
  * 首先，现在许多设备都支持Python预置\(on-box\)。这意味着你能够将Python动态解释器预置到设备，在每个网络设备本地执行Python脚本。
  * 其次，现在许多设备都支持SNMP和SSH以外的更强大的API，例如NETCONF和基于RESTful HTTP的API。在过去18到24个月内\(该书第一版在2018年出版\)出现的许多较新的设备操作系统上都支持其中一个或两个API。
  * 最后，网络设备正在公开更多Linux内部结构，而这些内部结构在过去一直被网络运营商所隐藏。你现在可以在网络设备上进入bash shell，并通过apt和yum等包管理器发出ifconfig等命令，编写bash脚本，安装监控和配置管理工具。
* 虽然开放网络并不总是意味着互操作性，但很明显网络设备和控制器正在“开放自己”，以一种更适合增强网络自动化的程序化方式进行操作。网络设备上有许多几年前还不存在的API，从思科的NX-API、Arista的eAPI、思科的IOS-XE RESTCONF/NETCONF到任何新的SDN控制器都有API。对于作为运维人员来说，最终的结果是，当你开始使用这些API时，你可以控制你的网络，并减少今天存在的一些运维效率低下的情况。

